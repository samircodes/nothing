Dim isHidden As Boolean ' Track whether columns are currently hidden

Sub ToggleZeroSumColumns()
    Dim pt As PivotTable
    Dim pf As PivotField
    Dim ws As Worksheet
    Dim lastCol As Long
    Dim i As Long
    Dim colSum As Double
    Dim j As Long
    Dim cellValue As Double
    Dim btn As Button
    
    Set ws = ThisWorkbook.Sheets("BU_pivot")
    Set pt = ws.PivotTables("PivotTable2") ' Use the name of your pivot table
    Set btn = ws.Buttons("Button1")
    
    ' Get the last column in the PivotTable's data range
    lastCol = pt.DataBodyRange.Columns.Count
    
    ' Always unhide all columns first before applying the new logic
    For i = 1 To lastCol
        ws.Columns(pt.DataBodyRange.Cells(1, i).Column).EntireColumn.Hidden = False
    Next i
    
    ' Toggle between hiding and unhiding
    If isHidden Then
        ' Unhide all columns (this is already done above)
        btn.Caption = "Click to hide"
        isHidden = False
    Else
        ' Hide columns where the sum is zero
        For i = 1 To lastCol
            colSum = 0
            ' Loop through each cell in the column to calculate the sum
            For j = 1 To pt.DataBodyRange.Rows.Count
                cellValue = 0 ' Default to 0 in case of non-numeric or empty cells
                On Error Resume Next
                cellValue = CLng(pt.DataBodyRange.Cells(j, i).Value) ' Convert to integer (CLng)
                On Error GoTo 0
                colSum = colSum + cellValue
            Next j
            
            ' Hide the column if the sum is zero
            If colSum = 0 Then
                ws.Columns(pt.DataBodyRange.Cells(1, i).Column).EntireColumn.Hidden = True
            End If
        Next i
        btn.Caption = "Click to unhide"
        isHidden = True
    End If
End Sub

Sub Worksheet_PivotTableUpdate(ByVal Target As PivotTable)
    ' Always unhide all columns first when the pivot table is updated
    Call ToggleZeroSumColumns
End Sub
