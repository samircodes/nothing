Dim isHidden As Boolean ' Track whether columns are currently hidden

Sub ToggleZeroSumColumns()
    Dim pt As PivotTable
    Dim ws As Worksheet
    Dim lastCol As Long
    Dim i As Long
    Dim colSum As Double
    Dim j As Long
    Dim cellValue As Double
    Dim btn As Button
    
    Set ws = ThisWorkbook.Sheets("BU_pivot")
    Set pt = ws.PivotTables("PivotTable2") ' Use the name of your pivot table
    Set btn = ws.Buttons("Button1")
    
    ' Get the last column in the PivotTable's data range
    lastCol = pt.DataBodyRange.Columns.Count
    
    ' Always unhide all columns first before applying the new logic
    For i = 1 To lastCol
        ws.Columns(pt.DataBodyRange.Cells(1, i).Column).EntireColumn.Hidden = False
    Next i
    
    ' Check the current state of isHidden
    If isHidden Then
        ' Hide columns where the sum is zero
        For i = 1 To lastCol
            colSum = 0
            ' Loop through each cell in the column to calculate the sum
            For j = 1 To pt.DataBodyRange.Rows.Count
                cellValue = 0 ' Default to 0 in case of non-numeric or empty cells
                On Error Resume Next
                cellValue = CLng(pt.DataBodyRange.Cells(j, i).Value) ' Convert to integer (CLng)
                On Error GoTo 0
                colSum = colSum + cellValue
            Next j
            
            ' Hide the column if the sum is zero
            If colSum = 0 Then
                ws.Columns(pt.DataBodyRange.Cells(1, i).Column).EntireColumn.Hidden = True
            End If
        Next i
    End If
End Sub

Sub Button_Click()
    Dim ws As Worksheet
    Dim btn As Button
    Set ws = ThisWorkbook.Sheets("BU_pivot")
    Set btn = ws.Buttons("Button1")
    
    ' Toggle the state
    If isHidden Then
        isHidden = False
        btn.Caption = "Click to hide"
    Else
        isHidden = True
        btn.Caption = "Click to unhide"
    End If
    
    ' Call the function to handle hiding/unhiding
    Call ToggleZeroSumColumns
End Sub

Private Sub Worksheet_PivotTableUpdate(ByVal Target As PivotTable)
    ' When the pivot table is updated (e.g., filter is changed), maintain the current hidden state
    Call ToggleZeroSumColumns
End Sub
