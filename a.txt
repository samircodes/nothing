import pandas as pd
import xlwings as xw

# Excel PivotField orientation constants
xlPageField = 3
xlColumnField = 2
xlRowField = 1
xlDataField = 4

# Sample data
data = {
    'Business Unit': ['BU1', 'BU1', 'BU2', 'BU2'],
    'Scenario': ['Actual', 'Forecast', 'Actual', 'Forecast'],
    'Period': ['Q1', 'Q2', 'Q1', 'Q2'],
    'Profit': [100, 150, 200, 250],
    'Loss': [20, 30, 40, 50]
}
df = pd.DataFrame(data)

# Save path
save_path = r'C:\Users\YourUsername\Documents\real_pivot.xlsx'

# Start Excel app
app = xw.App(visible=True)
wb = app.books.add()

# Write data to sheet
sheet_data = wb.sheets[0]
sheet_data.name = "Data"

# Write headers + data starting from A1
sheet_data.range("A1").value = df.columns.tolist()
sheet_data.range("A2").value = df.values.tolist()

# Define correct range (starting from A1)
num_rows = df.shape[0] + 1  # +1 for header
num_cols = df.shape[1]
source_range = sheet_data.range((1, 1), (num_rows, num_cols))

# Add Pivot sheet
sheet_pivot = wb.sheets.add("Pivot")

# Create Pivot Table
wb.api.PivotTableWizard(
    SourceType=1,
    SourceData=source_range.api,
    TableDestination=sheet_pivot.range("A3").api,
    TableName="MyPivotTable"
)

# Access the pivot table
pivot_table = sheet_pivot.api.PivotTables("MyPivotTable")

# Assign pivot fields
pivot_table.PivotFields("Business Unit").Orientation = xlPageField
pivot_table.PivotFields("Scenario").Orientation = xlPageField
pivot_table.PivotFields("Period").Orientation = xlColumnField
pivot_table.PivotFields("Profit").Orientation = xlDataField
pivot_table.PivotFields("Loss").Orientation = xlDataField

# Save
wb.save(save_path)
# wb.close()
# app.quit()
